<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>生産進捗トラッキングシステム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS -->
  <link rel="stylesheet" href="style.css">

  <!-- QRコードスキャン用ライブラリ (html5-qrcode) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- QRコード生成用ライブラリ (qrcodejs) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<header class="app-header">
  <h1>生産進捗トラッキングシステム</h1>
  <p class="subtitle">リアルタイムで進捗と不良を可視化する簡易生産管理</p>
</header>

<nav class="app-nav">
  <button class="nav-button active" data-tab="scan-tab">スキャン</button>
  <button class="nav-button" data-tab="dashboard-tab">ダッシュボード</button>
  <button class="nav-button" data-tab="admin-tab">管理者</button>
</nav>

<main class="app-main">

  <!-- スキャンタブ -->
  <section id="scan-tab" class="tab-panel active">
    <!-- ユーザー情報 -->
    <div class="card">
      <h2>1. ユーザー認証</h2>
      <p>ユーザーQRコードをスキャンしてログインしてください。</p>
      <div class="user-info">
        <div><strong>ログインユーザー:</strong> <span id="current-user-name">未ログイン</span></div>
        <div><strong>ユーザーID:</strong> <span id="current-user-id">-</span></div>
        <div><strong>権限:</strong> <span id="current-user-role">-</span></div>
      </div>
      <button id="btn-start-user-scan" class="primary-button">ユーザーQRスキャン開始</button>
      <div id="qr-reader" class="qr-reader"></div>
    </div>

    <!-- 端末スキャンと作業 -->
    <div class="card">
      <h2>2. 工程・端末スキャン</h2>
      <p>端末のQRコードをスキャンし、開始/終了と数量を入力してください。</p>

      <div class="terminal-info">
        <div><strong>選択中端末:</strong> <span id="current-terminal-name">未選択</span></div>
        <div><strong>工程:</strong> <span id="current-process-name">-</span></div>
        <div><strong>ロケーション:</strong> <span id="current-location">-</span></div>
      </div>

      <button id="btn-start-terminal-scan" class="secondary-button">端末QRスキャン開始</button>

      <div class="form-grid">
        <div class="form-group">
          <label for="product-code-input">製品番号 / ロット番号</label>
          <input id="product-code-input" type="text" placeholder="例: P-20251120-001">
        </div>

        <div class="form-group">
          <label>処理モード</label>
          <div class="radio-group">
            <label><input type="radio" name="mode" value="start" checked> 開始</label>
            <label><input type="radio" name="mode" value="end"> 終了</label>
          </div>
          <small>開始を選択すると開始時刻が記録され、終了で実績が保存されます。</small>
        </div>

        <div class="form-group">
          <label for="status-select">ステータス</label>
          <select id="status-select">
            <option value="通常">通常</option>
            <option value="検査保留">検査保留（検査工程のみ）</option>
          </select>
        </div>

        <div class="form-group">
          <label for="qty-total-input">総数量</label>
          <input id="qty-total-input" type="number" min="0" value="0">
        </div>

        <div class="form-group">
          <label for="qty-ok-input">OK数量</label>
          <input id="qty-ok-input" type="number" min="0" value="0">
        </div>

        <div class="form-group">
          <label for="qty-ng-input">不良数量</label>
          <input id="qty-ng-input" type="number" min="0" value="0">
        </div>
      </div>

      <div class="button-row">
        <button id="btn-save-log" class="primary-button">保存</button>
        <button id="btn-clear-form" class="ghost-button">クリア</button>
      </div>

      <p class="hint">
        ・「開始」を保存するとローカルに開始時刻が記憶されます。<br>
        ・同じユーザー + 端末 + 製品番号で「終了」を保存すると、開始〜終了の時間差で「所要時間」が自動計算されます。
      </p>
    </div>
  </section>

  <!-- ダッシュボードタブ -->
  <section id="dashboard-tab" class="tab-panel">
    <div class="card">
      <h2>ダッシュボード（進捗状況）</h2>
      <p>最新の工程実績が新しい順に表示されます。フィルターで絞り込みできます。</p>

      <div class="filter-grid">
        <div class="form-group">
          <label for="filter-process">工程フィルター</label>
          <select id="filter-process">
            <option value="">すべて</option>
            <option>レザー加工</option>
            <option>外注工程</option>
            <option>曲げ加工</option>
            <option>準備工程</option>
            <option>外枠組立工程</option>
            <option>パンタ組立工程</option>
            <option>シャッター組立工程</option>
            <option>スポット工程</option>
            <option>コーキング工程</option>
            <option>溶接工程</option>
            <option>組立工程</option>
            <option>検査工程</option>
            <option>検査保留</option>
            <option>出荷準備</option>
            <option>出荷完成</option>
          </select>
        </div>

        <div class="form-group">
          <label for="filter-terminal">端末フィルター</label>
          <input id="filter-terminal" type="text" placeholder="端末IDまたは名称で検索">
        </div>

        <div class="form-group">
          <label for="filter-product">製品番号フィルター</label>
          <input id="filter-product" type="text" placeholder="製品番号/ロット番号">
        </div>

        <div class="form-group">
          <label>期間フィルター（開始〜終了）</label>
          <div class="date-range">
            <input id="filter-date-from" type="date">
            <span>〜</span>
            <input id="filter-date-to" type="date">
          </div>
        </div>
      </div>

      <div class="button-row">
        <button id="btn-refresh-dashboard" class="secondary-button">更新</button>
        <button id="btn-export-product" class="ghost-button">製品別Excelエクスポート</button>
      </div>

      <div class="table-wrapper">
        <table id="logs-table">
          <thead>
            <tr>
              <th>時刻(終了)</th>
              <th>製品番号</th>
              <th>工程</th>
              <th>端末</th>
              <th>ユーザー</th>
              <th>数量(OK/不良)</th>
              <th>ステータス</th>
              <th>所要時間(分)</th>
              <th>ロケーション</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="logs-tbody">
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 管理者タブ -->
  <section id="admin-tab" class="tab-panel">
    <div class="card">
      <h2>管理者メニュー</h2>
      <p>管理者権限ユーザーでログインすると使用できます。（ロール: admin）</p>
      <p id="admin-guard-message" class="warning">
        現在のユーザーには管理者権限がありません。
      </p>

      <div id="admin-content" class="admin-grid hidden">
        <!-- ユーザー登録 -->
        <div class="admin-section">
          <h3>ユーザー登録</h3>
          <div class="form-group">
            <label for="admin-user-id">ユーザーID</label>
            <input id="admin-user-id" type="text" placeholder="例: U001">
          </div>
          <div class="form-group">
            <label for="admin-user-name">氏名（日本語）</label>
            <input id="admin-user-name" type="text" placeholder="例: 山田 太郎">
          </div>
          <div class="form-group">
            <label for="admin-user-role">権限</label>
            <select id="admin-user-role">
              <option value="operator">オペレーター</option>
              <option value="qc">QC</option>
              <option value="admin">管理者</option>
            </select>
          </div>
          <button id="btn-admin-create-user" class="primary-button">ユーザー登録</button>

          <h4>ユーザーQRコード</h4>
          <p>登録後に下のQRコードを印刷して、現場で使用してください。</p>
          <div id="user-qr-container" class="qr-container"></div>
        </div>

        <!-- 端末登録 -->
        <div class="admin-section">
          <h3>端末登録</h3>
          <div class="form-group">
            <label for="admin-terminal-id">端末ID</label>
            <input id="admin-terminal-id" type="text" placeholder="例: T001">
          </div>
          <div class="form-group">
            <label for="admin-terminal-name">端末名称</label>
            <input id="admin-terminal-name" type="text" placeholder="例: レザー加工端末1">
          </div>
          <div class="form-group">
            <label for="admin-terminal-process">工程</label>
            <select id="admin-terminal-process">
              <option>レザー加工</option>
              <option>外注工程</option>
              <option>曲げ加工</option>
              <option>準備工程</option>
              <option>外枠組立工程</option>
              <option>パンタ組立工程</option>
              <option>シャッター組立工程</option>
              <option>スポット工程</option>
              <option>コーキング工程</option>
              <option>溶接工程</option>
              <option>組立工程</option>
              <option>検査工程</option>
              <option>出荷準備</option>
              <option>出荷完成</option>
            </select>
          </div>
          <div class="form-group">
            <label for="admin-terminal-location">ロケーション</label>
            <input id="admin-terminal-location" type="text" placeholder="例: 第1工場 ラインA">
          </div>
          <button id="btn-admin-create-terminal" class="primary-button">端末登録</button>

          <h4>端末QRコード</h4>
          <p>登録後に下のQRコードを印刷して、各工程の端末に貼り付けてください。</p>
          <div id="terminal-qr-container" class="qr-container"></div>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- 編集モーダル -->
<div id="edit-modal" class="modal hidden">
  <div class="modal-content">
    <h3>ログ編集</h3>
    <input type="hidden" id="edit-log-id">
    <div class="form-group">
      <label for="edit-qty-total">総数量</label>
      <input id="edit-qty-total" type="number" min="0">
    </div>
    <div class="form-group">
      <label for="edit-qty-ok">OK数量</label>
      <input id="edit-qty-ok" type="number" min="0">
    </div>
    <div class="form-group">
      <label for="edit-qty-ng">不良数量</label>
      <input id="edit-qty-ng" type="number" min="0">
    </div>
    <div class="form-group">
      <label for="edit-status">ステータス</label>
      <select id="edit-status">
        <option value="通常">通常</option>
        <option value="検査保留">検査保留</option>
        <option value="終了">終了</option>
      </select>
    </div>
    <div class="button-row">
      <button id="btn-edit-save" class="primary-button">更新</button>
      <button id="btn-edit-cancel" class="ghost-button">キャンセル</button>
    </div>
  </div>
</div>

<script src="app.js"></script>
</body>
</html>
