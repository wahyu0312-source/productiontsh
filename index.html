<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>生産進捗トラッキングシステム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2f80ed">
  <link rel="icon" type="image/png" href="tsh.png">

  <!-- CSS -->
  <link rel="stylesheet" href="style.css">

  <!-- Libs -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
<div class="app-shell">

  <!-- Sidebar -->
  <aside class="sidebar sidebar-hidden" id="sidebar">
    <div class="sidebar-logo">
      <img src="tsh.png" alt="ロゴ">
      <span>生産進捗</span>
    </div>
    <nav class="sidebar-nav">
      <button class="sidebar-link active" data-section="dashboard-section">ダッシュボード</button>
      <button class="sidebar-link" data-section="scan-section">スキャン</button>
      <button class="sidebar-link" data-section="plan-section">生産計画</button>
      <button class="sidebar-link admin-only" data-section="admin-section">ユーザー / QR</button>
      <button class="sidebar-link admin-only" data-section="terminalqr-section">工程QR一覧</button>
    </nav>
    <div class="sidebar-footer">
      v1.0
    </div>
  </aside>

  <!-- Main area -->
  <div class="main-area">

    <!-- Top bar -->
    <header class="topbar">
      <div class="topbar-left">
        <!-- スマホ用バーガーボタン -->
        <button id="btn-menu-toggle" class="burger-button" aria-label="メニュー">
          <span></span><span></span><span></span>
        </button>

        <div>
          <h1 class="topbar-title">生産進捗トラッキングシステム</h1>
          <p class="topbar-subtitle">リアルタイムで進捗と不良を可視化する簡易生産管理</p>
        </div>
      </div>

      <div class="topbar-right">
        <!-- クイック製品検索 -->
        <div class="quick-search">
          <input id="header-product-search" type="text" placeholder="製品番号検索">
          <button id="btn-header-search" class="ghost-button ghost-small">検索</button>
        </div>

        <!-- ヘルプボタン -->
        <button id="btn-help" class="ghost-icon-button" title="ヘルプ">?</button>

        <!-- ユーザー情報 -->
        <div class="user-chip">
          <div class="user-avatar">👤</div>
          <div class="user-meta">
            <div id="top-username">ゲスト</div>
            <div class="user-role"><span id="top-userrole">未ログイン</span></div>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main class="content">

      <!-- Dashboard -->
      <section id="dashboard-section" class="section active">
        <div class="card welcome-card">
          <div class="welcome-main">
            <div class="welcome-icon">👋</div>
            <div>
              <p class="welcome-title">ようこそ、<span id="welcome-name">ゲスト</span> さん。</p>
              <p class="welcome-text">最新の進捗状況と生産計画を確認しましょう。</p>
            </div>
          </div>
          <div class="welcome-meta">
            <div class="welcome-meta-item">
              <span class="meta-label">本日</span>
              <span id="welcome-date"></span>
            </div>
          </div>
        </div>

        <!-- サマリーカード -->
        <div class="summary-grid">
          <div class="summary-card">
            <p class="summary-label">本日の総生産数量</p>
            <p class="summary-value" id="summary-today-qty">0</p>
          </div>
          <div class="summary-card warning-card">
            <p class="summary-label">本日の不良数量</p>
            <p class="summary-value" id="summary-today-ng">0</p>
          </div>
          <div class="summary-card">
            <p class="summary-label">登録工程数</p>
            <p class="summary-value" id="summary-terminal-count">0</p>
          </div>
          <div class="summary-card">
            <p class="summary-label">登録生産計画数</p>
            <p class="summary-value" id="summary-plan-count">0</p>
          </div>
        </div>

        <!-- 全体 計画 vs 実績 -->
        <div class="card plan-actual-card">
          <h2 class="card-title">全体 計画 vs 実績</h2>
          <p class="plan-actual-text">
            計画数量: <span id="dashboard-plan-total">0</span> /
            実績数量: <span id="dashboard-actual-total">0</span>
            （達成率 <span id="dashboard-achievement-rate">0</span>%）
          </p>
          <div class="progress-bar">
            <div id="dashboard-progress-fill" class="progress-fill"></div>
          </div>
        </div>

        <!-- 最新の実績一覧 -->
        <div class="card">
          <div class="card-header-row">
            <h2 class="card-title">最新の実績一覧</h2>
            <button id="btn-dashboard-refresh" class="secondary-button">更新</button>
          </div>

          <div class="filter-grid">
            <div class="form-group">
              <label for="filter-terminal">工程フィルター</label>
              <select id="filter-terminal">
                <option value="">すべて</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filter-process-name">工程名フィルター</label>
              <input id="filter-process-name" type="text" placeholder="工程IDまたは名称で検索">
            </div>
            <div class="form-group">
              <label for="filter-product-code">製品番号フィルター</label>
              <input id="filter-product-code" type="text" placeholder="製品番号/ロット番号">
            </div>
            <div class="form-group">
              <label>期間フィルター</label>
              <div class="date-range">
                <input id="filter-date-from" type="date">
                <span>〜</span>
                <input id="filter-date-to" type="date">
              </div>
            </div>
          </div>

          <div class="button-row" style="margin-top: 6px;">
            <button id="btn-clear-filters" class="ghost-button">フィルタークリア</button>
            <button id="btn-export-excel" class="secondary-button">製品別Excelエクスポート</button>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>時刻(終了)</th>
                  <th>製品番号</th>
                  <th>工程</th>
                  <th>工程名</th>
                  <th>ユーザー</th>
                  <th>数量(OK/不良)</th>
                  <th>ステータス</th>
                  <th>所要時間(分)</th>
                  <th>ロケーション</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="dashboard-latest-tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- 工程別 生産量チャート -->
        <div class="card chart-card">
          <h2 class="card-title">工程別 生産量（直近7日）</h2>
          <div class="chart-wrapper">
            <canvas id="dashboard-term-chart"></canvas>
          </div>
        </div>
      </section>

      <!-- Scan -->
      <section id="scan-section" class="section">
        <div class="card">
          <h2 class="card-title">スキャン / 実績登録</h2>

          <div class="ticker-card">
            <div class="ticker-label">INFO</div>
            <div class="ticker-content">
              <div id="scan-ticker" class="ticker-text">
                工程のQR → ユーザーQR → 製品番号 または ロット + 数量の順でスキャンすると、実績が自動登録されます。
              </div>
            </div>
          </div>

          <div class="user-info">
            <div><strong>現在の工程:</strong> <span id="current-terminal-name">未選択</span></div>
            <div><strong>現在のユーザー:</strong> <span id="current-user-name">未ログイン</span></div>
            <div><strong>ロケーション:</strong> <span id="current-location-label">-</span></div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="required-label" for="scan-product-code">製品番号 または ロット番号</label>
              <input id="scan-product-code" type="text" placeholder="例: P-20251120-001">
            </div>
            <div class="form-group">
              <label class="required-label" for="scan-qty-ok">数量（OK）</label>
              <input id="scan-qty-ok" type="number" min="0" value="0">
            </div>
            <div class="form-group">
              <label for="scan-qty-ng">数量（不良）</label>
              <input id="scan-qty-ng" type="number" min="0" value="0">
            </div>
            <div class="form-group">
              <label for="scan-status">ステータス</label>
              <select id="scan-status">
                <option value="completed">完了</option>
                <option value="hold">保留</option>
                <option value="rework">手直し</option>
              </select>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="scan-start-time">開始時刻（任意）</label>
              <input id="scan-start-time" type="datetime-local">
            </div>
            <div class="form-group">
              <label for="scan-end-time">終了時刻（任意）</label>
              <input id="scan-end-time" type="datetime-local">
            </div>
          </div>

          <div class="button-row">
            <button id="btn-open-qr-reader" class="secondary-button">QRリーダーを起動</button>
            <button id="btn-register-result" class="primary-button">実績登録</button>
            <button id="btn-clear-scan-form" class="ghost-button">クリア</button>
          </div>

          <div id="scan-qrcode-reader" class="qr-reader hidden"></div>

          <p class="hint">
            ※ カメラが使えない環境では、製品番号と数量を直接入力して「実績登録」を押してください。
          </p>

          <p id="offline-indicator" class="warning hidden">
            オフラインモードです。保存したデータはオンライン復帰後に自動送信されます。
          </p>
        </div>
      </section>

      <!-- Plan -->
      <section id="plan-section" class="section">
        <div class="card">
          <h2 class="card-title">生産計画入力</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="plan-product-code">製品番号</label>
              <input id="plan-product-code" type="text" placeholder="例: P-20251120-001">
            </div>
            <div class="form-group">
              <label for="plan-product-name">製品名</label>
              <input id="plan-product-name" type="text" placeholder="例: シャッターA">
            </div>
            <div class="form-group">
              <label for="plan-process">工程名</label>
              <select id="plan-process">
                <option>レザー加工</option>
                <option>外注工程</option>
                <option>曲げ加工</option>
                <option>組立工程</option>
                <option>検査工程</option>
                <option>出荷準備</option>
                <option>出荷完成</option>
              </select>
            </div>
            <div class="form-group">
              <label for="plan-qty">計画数量</label>
              <input id="plan-qty" type="number" min="0" value="0">
            </div>
            <div class="form-group">
              <label for="plan-start">計画開始</label>
              <input id="plan-start" type="datetime-local">
            </div>
            <div class="form-group">
              <label for="plan-end">計画終了</label>
              <input id="plan-end" type="datetime-local">
            </div>
            <div class="form-group">
              <label for="plan-status">ステータス</label>
              <select id="plan-status">
                <option value="planned">計画</option>
                <option value="in-progress">進行中</option>
                <option value="completed">完了</option>
              </select>
            </div>
          </div>

          <div class="button-row">
            <button id="btn-save-plan" class="primary-button">計画保存</button>
            <button id="btn-clear-plan" class="ghost-button">クリア</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header-row">
            <h2 class="card-title">生産計画一覧</h2>
            <button id="btn-refresh-plans" class="secondary-button">更新</button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>製品番号</th>
                  <th>製品名</th>
                  <th>工程名</th>
                  <th>計画数量</th>
                  <th>計画開始</th>
                  <th>計画終了</th>
                  <th>ステータス</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="plans-tbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2 class="card-title">生産計画インポート（CSV）</h2>
          <p>Excelから「CSV UTF-8」で保存し、1行目をヘッダーとして貼り付けてください。<br>
            列順: 製品番号, 製品名, 工程名, 計画数量, 計画開始, 計画終了, ステータス
          </p>
          <div class="form-group">
            <textarea id="plan-import-text" rows="6" placeholder="製品番号,製品名,工程名,計画数量,計画開始,計画終了,ステータス"></textarea>
          </div>
          <button id="btn-import-plans" class="secondary-button">インポート実行</button>
        </div>
      </section>

      <!-- Admin: user & terminal register -->
      <section id="admin-section" class="section">
        <!-- 登録フォーム -->
        <div class="card">
          <h2 class="card-title">管理者メニュー（ユーザー / 工程登録）</h2>
          <p>管理者権限ユーザーでログインすると使用できます。（ロール: admin）</p>
          <p id="admin-guard-message" class="warning">
            現在のユーザーには管理者権限がありません。
          </p>
          <div id="admin-content" class="admin-grid hidden">
            <div class="admin-section">
              <h3>ユーザー登録</h3>
              <div class="form-group">
                <label for="admin-user-id">ユーザーID</label>
                <input id="admin-user-id" type="text" placeholder="例: U001">
              </div>
              <div class="form-group">
                <label for="admin-user-name">氏名（日本語）</label>
                <input id="admin-user-name" type="text" placeholder="例: 山田 太郎">
              </div>
              <div class="form-group">
                <label for="admin-user-role">権限</label>
                <select id="admin-user-role">
                  <option value="operator">オペレーター</option>
                  <option value="qc">QC</option>
                  <option value="admin">管理者</option>
                </select>
              </div>
              <div class="button-row">
                <button id="btn-register-user" class="primary-button">ユーザー登録</button>
              </div>

              <h4>ユーザーQRコード</h4>
              <p class="hint">登録後に下のQRコードを印刷して、現場で使用してください。</p>
              <div id="admin-user-qr" class="qr-container"></div>
            </div>

            <div class="admin-section">
              <h3>工程登録</h3>
              <div class="form-group">
                <label for="admin-terminal-id">工程ID</label>
                <input id="admin-terminal-id" type="text" placeholder="例: T001">
              </div>
              <div class="form-group">
                <label for="admin-terminal-name">工程名称</label>
                <input id="admin-terminal-name" type="text" placeholder="例: レザー加工工程1">
              </div>
              <div class="form-group">
                <label for="admin-process-code">工程</label>
                <select id="admin-process-code">
                  <option value="レザー加工">レザー加工</option>
                  <option value="外注工程">外注工程</option>
                  <option value="曲げ加工">曲げ加工</option>
                  <option value="組立工程">組立工程</option>
                  <option value="検査工程">検査工程</option>
                  <option value="出荷準備">出荷準備</option>
                  <option value="出荷完成">出荷完成</option>
                </select>
              </div>
              <div class="form-group">
                <label for="admin-location">ロケーション</label>
                <input id="admin-location" type="text" placeholder="例: 第1工場 ラインA">
              </div>
              <div class="button-row">
                <button id="btn-register-terminal" class="primary-button">工程登録</button>
              </div>

              <h4>工程QRコード</h4>
              <p class="hint">登録後に下のQRコードを印刷して、各工程の端末に貼り付けてください。</p>
              <div id="admin-terminal-qr" class="qr-container"></div>
            </div>
          </div>
        </div>

        <!-- ユーザー一覧 / QRラベル -->
        <div id="admin-user-list-card" class="card hidden">
          <h3 class="card-title">ユーザー一覧 / QRラベル</h3>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>QR</th>
                  <th>ユーザーID</th>
                  <th>氏名</th>
                  <th>権限</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="admin-user-list-tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- 工程一覧 / QRラベル -->
        <div id="admin-terminal-list-card" class="card hidden">
          <h3 class="card-title">工程一覧 / QRラベル</h3>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>QR</th>
                  <th>工程ID</th>
                  <th>工程名称</th>
                  <th>工程</th>
                  <th>ロケーション</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="admin-terminal-list-tbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Terminal QR List -->
      <section id="terminalqr-section" class="section">
        <div class="card">
          <h2 class="card-title">工程QR一覧（印刷用）</h2>
          <p>すべての工程のQRコードを一覧表示します。このページを印刷して現場に配布してください。</p>
          <p id="terminalqr-guard" class="warning">
            管理者としてログインすると表示されます。（ロール: admin）
          </p>
          <div id="terminal-qr-list" class="terminalqr-grid hidden"></div>
        </div>
      </section>

    </main>

    <footer class="app-footer">
      Design by Wahyu
    </footer>

  </div>
</div>

<!-- 編集モーダル -->
<div id="edit-modal" class="modal hidden">
  <div class="modal-content">
    <h3 class="card-title">実績の編集</h3>
    <div class="form-group">
      <label for="edit-qty-ok">数量（OK）</label>
      <input id="edit-qty-ok" type="number" min="0">
    </div>
    <div class="form-group">
      <label for="edit-qty-ng">数量（不良）</label>
      <input id="edit-qty-ng" type="number" min="0">
    </div>
    <div class="form-group">
      <label for="edit-status">ステータス</label>
      <select id="edit-status">
        <option value="completed">完了</option>
        <option value="hold">保留</option>
        <option value="rework">手直し</option>
      </select>
    </div>
    <div class="button-row">
      <button id="btn-edit-save" class="primary-button">保存</button>
      <button id="btn-edit-cancel" class="ghost-button">キャンセル</button>
    </div>
  </div>
</div>

<!-- Loading / Toast -->
<div id="global-loading" class="loading-badge hidden">
  <div class="spinner"></div>
  <span id="global-loading-text">処理中...</span>
</div>

<div id="toast" class="toast hidden"></div>

<!-- App -->
<script src="app.js"></script>
<script src="service-worker.js"></script>
</body>
</html>
